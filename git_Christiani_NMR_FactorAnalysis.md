This is an R Markdown document applying Factor Analysis on preprocessed Metabolomics NMR pilot data (n=193) generated by the Christiani lab.

Setup environment
-----------------

Load required libraries
-----------------------

``` r
library(psych)
library(nFactors)
library(GPArotation)
library(ggplot2)
```

Load Christiani pilot data
--------------------------

``` r
NMR_log_cs<-read.csv(paste0(base.dir,'\\Christiani_NMR_log_cs.csv'),header=T)
```

Subset data to metabolites
--------------------------

``` r
names(NMR_log_cs)
NMR_sub<-NMR_log_cs[complete.cases(NMR_log_cs$ID),c(2,48:86)]
row.names(NMR_sub)<-NMR_sub$ID;NMR_sub<-NMR_sub[,-1]
dim(NMR_sub)
```

Determine factors underlying NMR log2/center/scaled dataset
-----------------------------------------------------------

``` r
ev <- eigen(cor(NMR_sub)) # get eigenvalues
ap <- fa.parallel(NMR_sub) # Consensus is 5 factors
```

![](git_Christiani_NMR_FactorAnalysis_files/figure-markdown_github/factors-1.png)

    ## Parallel analysis suggests that the number of factors =  5  and the number of components =  3

``` r
#nS <- scree(NMR_sub)
#VSS.scree(NMR_sub) 
#vss <- vss(NMR_sub,title="Very Simple Structure")


fa <- fa(NMR_sub,5,n.obs = 194,fm="minres", scores="tenBerge", warnings=TRUE)
print(fa,cut=0.3,digits=3, sort=T)
```

    ## Factor Analysis using method =  minres
    ## Call: fa(r = NMR_sub, nfactors = 5, n.obs = 194, scores = "tenBerge", 
    ##     warnings = TRUE, fm = "minres")
    ## Standardized loadings (pattern matrix) based upon correlation matrix
    ##                             item    MR1    MR5    MR2    MR3    MR4    h2
    ## Succinic_acid                 34  0.855                             0.849
    ## Glycerol                      25  0.839                             0.815
    ## Choline                       21  0.832                             0.674
    ## Myo_inositol                  37  0.800                             0.835
    ## Acetic_acid                   19  0.605                             0.550
    ## CAR_2_0_                      15  0.584                             0.649
    ## Creatine                      22  0.579                             0.705
    ## Citric_acid                    2  0.531                             0.440
    ## Lactic_acid                   28  0.524  0.368                      0.708
    ## Betaine                       20  0.503                0.371        0.445
    ## Phenylalanine                  9  0.477  0.431               -0.412 0.700
    ## Serine                        11  0.450  0.337                      0.571
    ## sn_glycero_3_phosphocholine   38  0.323                             0.218
    ## beta_hydroxybutyric_acid      18                                    0.198
    ## Valine                        14         0.877                      0.748
    ## X_1_Methylhistidine           39         0.782                      0.687
    ## Lysine                         8         0.774                      0.784
    ## Leucine                        7  0.339  0.695                      0.924
    ## Isoleucine                     6         0.654                      0.670
    ## Glycine                        5         0.637                      0.704
    ## Tyrosine                      13         0.591                      0.538
    ## Glutamic_acid                  4  0.303  0.500                      0.678
    ## Acetylcholine                 29         0.497                0.330 0.775
    ## Proline                       10         0.479                0.371 0.686
    ## Glycolic_acid                 26         0.387                0.304 0.459
    ## Alanine                        1         0.349                      0.282
    ## Creatinine                     3         0.318                      0.331
    ## X_3_amino_isobutanoic_acid    17                0.752               0.590
    ## Thymol                        35                0.643               0.373
    ## X_2_hydroxybutyric_acid       16         0.301  0.548               0.682
    ## Propionic_acid                31                0.438               0.491
    ## Isopropyl_alcohol             27                0.407               0.213
    ## Threonine                     12                0.333               0.376
    ## Glucose                       24                       0.820        0.655
    ## Pyruvic_acid                  33                      -0.492  0.383 0.441
    ## Propylene_glycol              32                       0.304        0.138
    ## Trimethylamine_N_oxide        36                              0.656 0.688
    ## Formic_acid                   23  0.331                      -0.422 0.339
    ## Choline_phosphate             30  0.305                       0.319 0.320
    ##                                 u2  com
    ## Succinic_acid               0.1514 1.27
    ## Glycerol                    0.1846 1.08
    ## Choline                     0.3255 1.09
    ## Myo_inositol                0.1652 1.36
    ## Acetic_acid                 0.4501 1.34
    ## CAR_2_0_                    0.3508 1.79
    ## Creatine                    0.2954 1.77
    ## Citric_acid                 0.5604 2.37
    ## Lactic_acid                 0.2922 2.48
    ## Betaine                     0.5545 2.36
    ## Phenylalanine               0.2997 3.14
    ## Serine                      0.4287 2.21
    ## sn_glycero_3_phosphocholine 0.7824 3.78
    ## beta_hydroxybutyric_acid    0.8018 2.52
    ## Valine                      0.2516 1.06
    ## X_1_Methylhistidine         0.3135 1.27
    ## Lysine                      0.2156 1.66
    ## Leucine                     0.0764 1.61
    ## Isoleucine                  0.3304 1.31
    ## Glycine                     0.2962 1.79
    ## Tyrosine                    0.4623 1.61
    ## Glutamic_acid               0.3223 2.23
    ## Acetylcholine               0.2253 2.88
    ## Proline                     0.3143 2.36
    ## Glycolic_acid               0.5407 2.45
    ## Alanine                     0.7180 2.59
    ## Creatinine                  0.6689 2.71
    ## X_3_amino_isobutanoic_acid  0.4098 1.02
    ## Thymol                      0.6271 1.21
    ## X_2_hydroxybutyric_acid     0.3181 1.92
    ## Propionic_acid              0.5089 2.12
    ## Isopropyl_alcohol           0.7868 2.54
    ## Threonine                   0.6235 3.23
    ## Glucose                     0.3449 1.02
    ## Pyruvic_acid                0.5592 2.03
    ## Propylene_glycol            0.8624 2.80
    ## Trimethylamine_N_oxide      0.3116 1.48
    ## Formic_acid                 0.6613 2.49
    ## Choline_phosphate           0.6803 4.08
    ## 
    ##                         MR1   MR5   MR2   MR3   MR4
    ## SS loadings           7.389 7.138 2.943 2.113 2.345
    ## Proportion Var        0.189 0.183 0.075 0.054 0.060
    ## Cumulative Var        0.189 0.372 0.448 0.502 0.562
    ## Proportion Explained  0.337 0.326 0.134 0.096 0.107
    ## Cumulative Proportion 0.337 0.662 0.797 0.893 1.000
    ## 
    ##  With factor correlations of 
    ##        MR1    MR5   MR2    MR3   MR4
    ## MR1  1.000  0.550 0.132 -0.058 0.121
    ## MR5  0.550  1.000 0.330 -0.164 0.237
    ## MR2  0.132  0.330 1.000  0.099 0.342
    ## MR3 -0.058 -0.164 0.099  1.000 0.005
    ## MR4  0.121  0.237 0.342  0.005 1.000
    ## 
    ## Mean item complexity =  2.1
    ## Test of the hypothesis that 5 factors are sufficient.
    ## 
    ## The degrees of freedom for the null model are  741  and the objective function was  32.202 with Chi Square of  5769.594
    ## The degrees of freedom for the model are 556  and the objective function was  6.429 
    ## 
    ## The root mean square of the residuals (RMSR) is  0.04 
    ## The df corrected root mean square of the residuals is  0.047 
    ## 
    ## The harmonic number of observations is  194 with the empirical chi square  468.293  with prob <  0.997 
    ## The total number of observations was  194  with Likelihood Chi Square =  1130.496  with prob <  1.95e-41 
    ## 
    ## Tucker Lewis Index of factoring reliability =  0.8444
    ## RMSEA index =  0.0799  and the 90 % confidence intervals are  0.067 NA
    ## BIC =  -1798.433
    ## Fit based upon off diagonal values = 0.988
    ## Measures of factor score adequacy             
    ##                                                     MR1   MR5   MR2   MR3
    ## Correlation of (regression) scores with factors   0.980 0.981 0.923 0.923
    ## Multiple R square of scores with factors          0.960 0.962 0.852 0.852
    ## Minimum correlation of possible factor scores     0.921 0.924 0.704 0.704
    ##                                                     MR4
    ## Correlation of (regression) scores with factors   0.927
    ## Multiple R square of scores with factors          0.860
    ## Minimum correlation of possible factor scores     0.719

``` r
fa.diagram(fa,rsize=0.15)
```

![](git_Christiani_NMR_FactorAnalysis_files/figure-markdown_github/factors-2.png)

``` r
fa_loadings<-unclass(fa$loadings)
fa_loadings<-as.data.frame(fa_loadings)

write.csv(fa_loadings, paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_full_loadings.csv"), row.names = T)

cut<-function(x) {ifelse(abs(x)<0.3,0,x)}
fa_loadings<-as.data.frame(t(apply(fa_loadings,1,cut)))
max_abs<-function (x) {max(abs(x))}
fa_loadings$max_abs<-apply(fa_loadings[,1:5],1,max_abs)
max_factor<-function (x) {which.max(abs(x))}
fa_loadings$max_factor<-colnames(fa_loadings)[apply(fa_loadings[,1:5],1,max_factor)] 
fa_loadings$max_factor<-ifelse(fa_loadings$max_abs==0,"None",fa_loadings$max_factor)
fa_loadings<-fa_loadings[order(fa_loadings$max_factor,-fa_loadings$max_abs),]

write.csv(fa_loadings, paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_loadings.csv"), row.names = T)


Alldata_scores<-fa$scores
write.csv(Alldata_scores, paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_scores.csv"), row.names = T)
```

Linear regression models of metabolite factors against birth weight z-scores (log2 transformed/centered/scaled)
---------------------------------------------------------------------------------------------------------------

``` r
NMR_EFA<-read.csv(paste0(base.dir,'\\FactorAnalysis\\NMR_EFA_scores.csv'),row.names=1)
NMR_EFA$ID<-row.names(NMR_EFA)
Data<-merge(NMR_log_cs,NMR_EFA,by='ID')

#crude models
NMR_MR1<-glm(birthweight  ~ MR1, data = Data)
summary(NMR_MR1)
#            Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  2.93108    0.02839 103.255  < 2e-16 ***
#MR1         -0.10914    0.02846  -3.835  0.00017 ***
NMR_MR2<-glm(birthweight  ~ MR2, data = Data)
summary(NMR_MR2)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  2.93108    0.02944  99.553   <2e-16 ***
#MR2          0.01150    0.02952   0.389    0.697  
NMR_MR3<-glm(birthweight  ~ MR3, data = Data)
summary(NMR_MR3)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  2.93108    0.02945   99.54   <2e-16 ***
#MR3          0.01005    0.02952    0.34    0.734   

NMR_MR4<-glm(birthweight  ~ MR4, data = Data)
summary(NMR_MR4)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  2.93108    0.02936  99.823   <2e-16 ***
#MR4         -0.03214    0.02944  -1.092    0.276    

NMR_MR5<-glm(birthweight  ~ MR5, data = Data)
summary(NMR_MR5)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  2.93108    0.02944  99.577   <2e-16 ***
#MR5         -0.01453    0.02951  -0.492    0.623

#adjusted models
Data$parity01<-as.factor(Data$parity01)
Data$gender<-as.factor(Data$gender)
Data$educat<-as.factor(Data$educat)

NMR_MR1<-glm(birthweight  ~ MR1+bmi+ga.spline1+ga.spline2+ga.spline3+parity01+gender+educat, data = Data)
summary(NMR_MR1)
#(Intercept)  1.829782   0.244832   7.474 3.06e-12 ***
#MR1         -0.051100   0.026990  -1.893 0.059886 . 

NMR_MR2<-glm(birthweight  ~ MR2+bmi+ga.spline1+ga.spline2+ga.spline3+parity01+gender+educat, data = Data)
summary(NMR_MR2)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.759397   0.243997   7.211 1.40e-11 ***
#MR2         -0.019687   0.026782  -0.735 0.463224    
NMR_MR3<-glm(birthweight  ~ MR3+bmi+ga.spline1+ga.spline2+ga.spline3+parity01+gender+educat, data = Data)
summary(NMR_MR3)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.759737   0.244195   7.206 1.43e-11 ***
#MR3          0.012899   0.026250   0.491 0.623730    

NMR_MR4<-glm(birthweight  ~ MR4+bmi+ga.spline1+ga.spline2+ga.spline3+parity01+gender+educat, data = Data)
summary(NMR_MR4)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.761288   0.244862   7.193 1.55e-11 ***
#MR4         -0.002795   0.026035  -0.107 0.914610    

NMR_MR5<-glm(birthweight  ~ MR5+bmi+ga.spline1+ga.spline2+ga.spline3+parity01+gender+educat, data = Data)
summary(NMR_MR5)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept)  1.733868   0.244749   7.084 2.88e-11 ***
#MR5         -0.028334   0.026266  -1.079  0.28212    
```

``` r
table_EFA<-as.data.frame(rbind(EFA1=t(summary(NMR_MR1)$coefficients[2,]),
                              EFA2=t(summary(NMR_MR2)$coefficients[2,]),
                              EFA3=t(summary(NMR_MR3)$coefficients[2,]),
                              EFA4=t(summary(NMR_MR4)$coefficients[2,]),
                              EFA5=t(summary(NMR_MR5)$coefficients[2,])))
                                      
row.names(table_EFA)<-c('EFA1','EFA2','EFA3','EFA4','EFA5')
Conf_NMR<-(as.data.frame(rbind(confint.default(NMR_MR1)[2,],confint.default(NMR_MR2)[2,],confint.default(NMR_MR3)[2,],confint.default(NMR_MR4)[2,],confint.default(NMR_MR5)[2,])))
row.names(Conf_NMR)<-c('EFA1','EFA2','EFA3','EFA4','EFA5')
table_EFA<-merge(table_EFA,Conf_NMR,by=0)
write.csv(table_EFA, paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_BW_Table1.csv"), row.names = T)
```

NMR/BW EFA Figure
=================

``` r
table_NMRBW<-read.csv(paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_BW_Table1.csv"),row.names=1,check.names=F)
names(table_NMRBW)[names(table_NMRBW)=='2.5 %']<-'LCL'
names(table_NMRBW)[names(table_NMRBW)=='97.5 %']<-'UCL'
ggplot(data=table_NMRBW,aes(x=Estimate,y=Row.names))+
  geom_point(size=4,shape=16)+
  geom_errorbarh(aes(xmin=LCL,xmax=UCL),height=0.2)+
  geom_vline(xintercept=0,linetype="dashed")+
  labs(x='Estimate (95% CI)')+
  theme_bw()+
  theme(axis.title.y=element_blank())
```

![](git_Christiani_NMR_FactorAnalysis_files/figure-markdown_github/figure_bw-1.png)

Linear regression models of metabolite factors against hc (log2 transformed/centered/scaled)
--------------------------------------------------------------------------------------------

``` r
NMR_EFA<-read.csv(paste0(base.dir,'\\FactorAnalysis\\NMR_EFA_scores.csv'),row.names=1)
NMR_EFA$ID<-row.names(NMR_EFA)
Data<-merge(NMR_log_cs,NMR_EFA,by='ID')

#crude models
NMR_MR1<-glm(headcircumference  ~ MR1, data = Data)
summary(NMR_MR1)
#            Estimate Std. Error t value Pr(>|t|)    
#(Intercept) 32.56516    0.09087 358.390   <2e-16 ***
#MR1         -0.12656    0.09095  -1.391    0.166  
NMR_MR2<-glm(headcircumference  ~ MR2, data = Data)
summary(NMR_MR2)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 32.56489    0.09131  356.65   <2e-16 ***
#MR2          0.02471    0.09152    0.27    0.787 
NMR_MR3<-glm(headcircumference  ~ MR3, data = Data)
summary(NMR_MR3)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 32.56455    0.09100 357.833   <2e-16 ***
#MR3          0.10551    0.09104   1.159    0.248    

NMR_MR4<-glm(headcircumference  ~ MR4, data = Data)
summary(NMR_MR4)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 32.56503    0.09004 361.658   <2e-16 ***
#MR4         -0.21065    0.09006  -2.339   0.0204 * 

NMR_MR5<-glm(headcircumference  ~ MR5, data = Data)
summary(NMR_MR5)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 32.56453    0.09101 357.828   <2e-16 ***
#MR5         -0.10532    0.09105  -1.157    0.249    

#adjusted models
Data$parity01<-as.factor(Data$parity01)
Data$gender<-as.factor(Data$gender)
Data$educat<-as.factor(Data$educat)

NMR_MR1<-glm(headcircumference  ~ MR1+bmi+ga.spline1+ga.spline2+ga.spline3+birthweight+parity01+gender+educat, data = Data)
summary(NMR_MR1)
#(Intercept) 28.91755    0.91839  31.487  < 2e-16 ***
#MR1          0.03341    0.08965   0.373   0.7098       

NMR_MR2<-glm(headcircumference  ~ MR2+bmi+ga.spline1+ga.spline2+ga.spline3+birthweight+parity01+gender+educat, data = Data)
summary(NMR_MR2)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 29.00024    0.89982  32.229  < 2e-16 ***
#MR2         -0.05811    0.08741  -0.665   0.5071   
NMR_MR3<-glm(headcircumference  ~ MR3+bmi+ga.spline1+ga.spline2+ga.spline3+birthweight+parity01+gender+educat, data = Data)
summary(NMR_MR3)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 28.99965    0.89896  32.259  < 2e-16 ***
#MR3          0.07355    0.08545   0.861   0.3905

NMR_MR4<-glm(headcircumference  ~ MR4+bmi+ga.spline1+ga.spline2+ga.spline3+birthweight+parity01+gender+educat, data = Data)
summary(NMR_MR4)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 29.08559    0.89396  32.536  < 2e-16 ***
#MR4         -0.15511    0.08398  -1.847   0.0664 .    

NMR_MR5<-glm(headcircumference  ~ MR5+bmi+ga.spline1+ga.spline2+ga.spline3+birthweight+parity01+gender+educat, data = Data)
summary(NMR_MR5)
#            Estimate Std. Error t value Pr(>|t|)
#(Intercept) 28.94126    0.89917  32.187  < 2e-16 ***
#MR5         -0.08687    0.08605  -1.010    0.314     
```

``` r
table_EFA<-as.data.frame(rbind(EFA1=t(summary(NMR_MR1)$coefficients[2,]),
                              EFA2=t(summary(NMR_MR2)$coefficients[2,]),
                              EFA3=t(summary(NMR_MR3)$coefficients[2,]),
                              EFA4=t(summary(NMR_MR4)$coefficients[2,]),
                              EFA5=t(summary(NMR_MR5)$coefficients[2,])))
                                      
row.names(table_EFA)<-c('EFA1','EFA2','EFA3','EFA4','EFA5')
Conf_NMR<-(as.data.frame(rbind(confint.default(NMR_MR1)[2,],confint.default(NMR_MR2)[2,],confint.default(NMR_MR3)[2,],confint.default(NMR_MR4)[2,],confint.default(NMR_MR5)[2,])))
row.names(Conf_NMR)<-c('EFA1','EFA2','EFA3','EFA4','EFA5')
table_EFA<-merge(table_EFA,Conf_NMR,by=0)
write.csv(table_EFA, paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_HC_Table1.csv"), row.names = T)
```

NMR/HC EFA Figure
=================

``` r
table_NMRHC<-read.csv(paste0(base.dir,"\\FactorAnalysis\\NMR_EFA_HC_Table1.csv"),row.names=1,check.names=F)
names(table_NMRHC)[names(table_NMRHC)=='2.5 %']<-'LCL'
names(table_NMRHC)[names(table_NMRHC)=='97.5 %']<-'UCL'
ggplot(data=table_NMRHC,aes(x=Estimate,y=Row.names))+
  geom_point(size=4,shape=16)+
  geom_errorbarh(aes(xmin=LCL,xmax=UCL),height=0.2)+
  geom_vline(xintercept=0,linetype="dashed")+
  labs(x='Estimate (95% CI)')+
  theme_bw()+
  theme(axis.title.y=element_blank())
```

![](git_Christiani_NMR_FactorAnalysis_files/figure-markdown_github/figure_hc-1.png)
