---
title: "RF analysis of Christiani NMR pilot data"
author: "Maya Deyssenroth"
date: "May 24, 2019"
output: 
  md_document:
    variant: markdown_github
editor_options: 
  chunk_output_type: console
---
This is an R Markdown document applying Random Forest on preprocessed Metabolomics NMR pilot data (n=194) generated by the Christiani lab.  Random Forest models testing associations between metabolites and birthweight (n=194)/head circumference (n=193) were run on a residualized matrix where the following covariates were regressed out: maternal age, maternal bmi, gestational age (cubic splines), infant gender, parity (0 vs. not 0), maternal education (0,1,2).

##Setup environment
```{r, echo=FALSE}
.libPaths('J:\\PM\\GenEnv\\Maya Kappil\\myRlib')
base.dir='J:\\PM\\Metabolomics\\Christiani';
```

##Load required libraries
```{r warning = FALSE, message=FALSE}
library(randomForest)
library(vita)
library(ranger)
```

##Load Christiani pilot data
```{r data}
nmr<-read.csv(paste0(base.dir,'\\Christiani_NMR_log_cs.csv'),header=T)
```

```{r clean data, echo=FALSE}
for (i in 1:ncol(nmr)){
  if (names(nmr)[i] %in% c("pid","age","bmi","birthweight","birthlength","headcircumference","ga")){
    nmr[[i]] <- as.numeric(as.character(nmr[[i]]))
  }
  else if (names(nmr)[i] %in% c("gender", "parity01", "educat")) {
    nmr[[i]] <- factor(nmr[[i]])
  }
  else next
}
```


##Residual adjustment
```{r}
# z-score of metabolites
nmr_metab_bw <- nmr[c(48:86)]
nmr_metab_bw <- as.data.frame(lapply(nmr_metab_bw, function(i) scale(i)))

##  Birthweight residual matrix
bw_model <- lm(birthweight ~ age + bmi + ga.spline1 + ga.spline2 + ga.spline3 + factor(gender) + factor(educat) + factor(parity01), data=nmr)
bw_adj <- mean(nmr$birthweight) + bw_model$residuals

nmr_metab_bw$birthweight_adjusted <- as.vector(bw_adj)

## Head circumference residual matrix
nmr_metab_hc <- nmr[c(48:86)]
nmr_metab_hc <- as.data.frame(lapply(nmr_metab_hc, function(i) scale(i)))
nmr_metab_hc <- nmr_metab_hc[-which(is.na(nmr$headcircumference)),]
nmr_hc <- nmr[-which(is.na(nmr$headcircumference)),]

hc_model <- lm(headcircumference ~ age + bmi + ga.spline1 + ga.spline2 + ga.spline3 + factor(gender) + factor(educat) + factor(parity01), data=nmr_hc)
hc_adj <- mean(nmr_hc$headcircumference) + hc_model$residuals

nmr_metab_hc$headcircumference_adjusted <- as.vector(hc_adj)

```


##Birth weight tuning
```{r}
seed_RF <- 123822

#grid of random forest parameters
hyper_grid <- expand.grid(
  ntree      = 1000,
  mtry       = c(3:6),
  node_size  = seq(3, 9, by = 2),
  sampe_size = c(.55, .632, .70, .80),
  OOB_RMSE   = 0
)

#loop through RF parameters
for(i in 1:nrow(hyper_grid)) {
  
  # train model
  model <- ranger(
    formula         = birthweight_adjusted ~ ., 
    data            = nmr_metab_bw, 
    num.trees       = 1000,
    mtry            = hyper_grid$mtry[i],
    min.node.size   = hyper_grid$node_size[i],
    sample.fraction = hyper_grid$sampe_size[i],
    seed            = seed_RF
  )
  
  # add OOB error to grid
  hyper_grid$OOB_RMSE[i] <- sqrt(model$prediction.error)
}

hyper_grid[which(hyper_grid$OOB_RMSE==min(hyper_grid$OOB_RMSE)),]

```


##Birth weight RF
```{r}
set.seed(seed_RF)
nmr_RF <- randomForest(birthweight_adjusted ~ ., data=nmr_metab_bw, 
                       ntree=1000, 
                       mtry=3,
                       nodesize=7, 
                       sampsize=ceiling(0.55*nrow(nmr_metab_bw)),
                       importance=TRUE)

varImpPlot(nmr_RF,type=1)
varImpPlot(nmr_RF,type=2)
```

##Birth weight variable selection (altman method)
```{r}
set.seed(seed_RF)
alt_result <- PIMP(nmr_metab_bw[-40], unlist(nmr_metab_bw[40]), nmr_RF, S=500)

summary(alt_result)
summary(PimpTest(alt_result))
```

##Head circumference tuning
```{r}
#grid of random forest parameters
hyper_grid <- expand.grid(
  ntree      = 1000,
  mtry       = c(3:6),
  node_size  = seq(3, 9, by = 2),
  sampe_size = c(.55, .632, .70, .80),
  OOB_RMSE   = 0
)

#loop through RF parameters
for(i in 1:nrow(hyper_grid)) {
  
  set.seed(seed_RF)
  
  # train model
  model <- ranger(
    formula         = headcircumference_adjusted ~ ., 
    data            = nmr_metab_hc, 
    num.trees       = 1000,
    mtry            = hyper_grid$mtry[i],
    min.node.size   = hyper_grid$node_size[i],
    sample.fraction = hyper_grid$sampe_size[i],
    seed            = seed_RF
  )
  
  # add OOB error to grid
  hyper_grid$OOB_RMSE[i] <- sqrt(model$prediction.error)
}

hyper_grid[which(hyper_grid$OOB_RMSE==min(hyper_grid$OOB_RMSE)),]


```

##Head circumference RF
```{r}
set.seed(seed_RF)
nmr_RF <- randomForest(headcircumference_adjusted ~ ., data=nmr_metab_hc, 
                       ntree=1000, 
                       mtry=6,
                       nodesize=7, 
                       sampsize=ceiling(0.8*nrow(nmr_metab_hc)),
                       importance=TRUE)

varImpPlot(nmr_RF,type=1)
varImpPlot(nmr_RF,type=2)
```


##Head circumference variable selection (altman method)
```{r}
set.seed(seed_RF)
alt_result <- PIMP(nmr_metab_hc[-40], unlist(nmr_metab_hc[40]), nmr_RF, S=500)

summary(PimpTest(alt_result))
```

